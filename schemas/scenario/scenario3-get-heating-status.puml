@startuml
!theme plain
title –°—Ü–µ–Ω–∞—Ä–∏–π 1 (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π): –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —Å requestId

actor "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" as User
participant "Web App" as Web
participant "API Gateway" as Gateway
participant "Auth Service" as Auth
participant "Heating Service" as Heating
participant "Message Broker" as Broker
participant "Heating Worker" as Worker
participant "IoT Gateway" as IoT
participant "Event Bus\n(WebSocket)" as Events
database "Heating DB" as HeatingDB

== –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ==
User -> Web: –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
Web -> Gateway: POST /api/auth/login\n{email, password}
Gateway -> Auth: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å credentials
Auth --> Gateway: 200 OK\n{accessToken, refreshToken, user}
Gateway --> Web: JWT Token

== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ==
Web -> Events: –û—Ç–∫—Ä—ã—Ç—å WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ\nws://api.smarthome.example.com/ws
Events --> Web: Connection established
Web -> Events: Subscribe to channel\n"heating/room-456/events"
Events --> Web: Subscribed successfully

== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ) ==
User -> Web: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å 22¬∞C –≤ –≥–æ—Å—Ç–∏–Ω–æ–π
Web -> Gateway: POST /api/heating/set-temperature\nAuthorization: Bearer <token>\n{roomId: "room-456", targetTemperature: 22}

Gateway -> Auth: –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å JWT —Ç–æ–∫–µ–Ω
Auth --> Gateway: Token valid, userId

Gateway -> Heating: POST /set-temperature\n{roomId: "room-456", targetTemperature: 22}

Heating -> HeatingDB: SELECT room WHERE id="room-456"
HeatingDB --> Heating: Room exists, has heating system

Heating -> Heating: –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å requestId\nrequestId = "req-abc123"

Heating -> Broker: Publish command to queue\n{"requestId": "req-abc123",\n"roomId": "room-456",\n"targetTemperature": 22,\n"userId": "user-789"}

note right of Heating
  –ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –æ—á–µ—Ä–µ–¥—å
  –∏ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
  Worker'–∞–º–∏
end note

Heating --> Gateway: **202 Accepted**\n{"message": "Temperature change command accepted",\n"requestId": "req-abc123",\n"roomId": "room-456",\n"targetTemperature": 22,\n"subscribeChannel": "heating/room-456/events",\n"estimatedCompletionTime": 900}

Gateway --> Web: 202 Accepted + requestId
Web -> User: ‚úÖ "–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–∏–Ω—è—Ç–∞"\nrequestId: req-abc123\n"–û–∂–∏–¥–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è..."

note right of Web
  –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏–ª requestId
  –∏ —Ç–µ–ø–µ—Ä—å –∂–¥–µ—Ç —Å–æ–±—ã—Ç–∏—è
  —á–µ—Ä–µ–∑ WebSocket
end note

== –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Worker'–æ–º ==
Broker -> Worker: Consume command from queue\n{requestId: "req-abc123", roomId, targetTemp: 22}

Worker -> HeatingDB: UPDATE heating_config\nSET target_temperature=22\nWHERE room_id="room-456"
HeatingDB --> Worker: Updated

Worker -> Events: Publish event\n**"target_temperature_updated"**\n{event: "target_temperature_updated",\nrequestId: "req-abc123",\nroomId: "room-456",\ntargetTemperature: 22,\ntimestamp: "..."}

Events -> Web: WebSocket push event
Web -> User: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:\n"–¶–µ–ª–µ–≤–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞: 22¬∞C"

Worker -> IoT: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É\nInclude heating relay\ndeviceId: "relay-heat-001"
IoT --> Worker: Relay activated

Worker -> Events: Publish event\n**"heating_started"**\n{event: "heating_started",\nroomId: "room-456",\ncurrentTemperature: 20.5,\ntargetTemperature: 22,\nreason: "Target temperature set by user"}

Events -> Web: WebSocket push event
Web -> User: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:\n"–û—Ç–æ–ø–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ üî•"

== –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã ==
loop –ö–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
  IoT -> Worker: –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É\n–æ—Ç sensor-temp-001
  Worker -> Events: Publish event\n**"temperature_changing"**\n{event: "temperature_changing",\nrequestId: "req-abc123",\ncurrentTemperature: 20.5‚Üí21.0‚Üí21.5,\ntargetTemperature: 22,\nprogress: 33%‚Üí66%‚Üí93%,\nestimatedTimeRemaining: 600‚Üí300‚Üí60}
  Events -> Web: WebSocket push event
  Web -> User: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:\n"21.5¬∞C (93% –≥–æ—Ç–æ–≤–æ)"
end

== –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã ==
IoT -> Worker: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–æ—Å—Ç–∏–≥–ª–∞ 22.0¬∞C
Worker -> IoT: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É\n–í—ã–∫–ª—é—á–∏—Ç—å –æ—Ç–æ–ø–ª–µ–Ω–∏–µ
IoT --> Worker: Relay deactivated

Worker -> Events: Publish event\n**"temperature_reached"**\n{event: "temperature_reached",\nrequestId: "req-abc123",\nroomId: "room-456",\ncurrentTemperature: 22.0,\ntargetTemperature: 22,\ntimeElapsed: 900}

Events -> Web: WebSocket push event
Web -> User: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:\n"–¶–µ–ª–µ–≤–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!"\n–í—Ä–µ–º—è: 15 –º–∏–Ω—É—Ç

note right of Web
  –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∑–∞–≤–µ—Ä—à–µ–Ω
  requestId: req-abc123
  Status: Completed
end note

@enduml