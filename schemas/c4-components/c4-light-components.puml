@startuml C4_Components_LightingService
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()

Container_Boundary(LightingService, "Lighting Service") {

    ' API Layer
    Component(LightingAPI, "Lighting API", "FastAPI Controller", "REST эндпоинты для управления светом")

    ' Application Layer
    Component(CommandHandler, "Command Handler", "Application Service", "Обработка команд: включить/выключить, установить яркость")
    Component(QueryHandler, "Query Handler", "Application Service", "Обработка запросов: получить статус, историю")
    Component(SchedulerService, "Scheduler Service", "Application Service", "Управление расписаниями света")

    ' Domain Layer
    Component(LightingDomainService, "Lighting Domain Service", "Domain Service", "Бизнес-логика управления светом")
    Component(LightingAggregate, "Lighting System Aggregate", "Aggregate Root", "Агрегат: система света, датчики, реле")
    Component(ValueObjects, "Value Objects", "Domain Model", "Температура, тип команды, статус света")

    ' Infrastructure Layer
    Component(LightingRepo, "Lighting Repository", "Repository", "CRUD операции \nс системами света")
    Component(DeviceRepo, "Device Repository", "Repository", "Работа с датчиками и реле")
    Component(EventPublisher, "Event Publisher", "Infrastructure", "Публикация событий в Message Broker")
    Component(EventHandler, "Event Handler", "Infrastructure", "Обработка событий от устройств")
    Component(StateManager, "State Manager", "Infrastructure", "Управление текущим состоянием")
}
ContainerDb(deviceServiceDb, "Device DB", "PostgreSQL", "Устройства, конфигурации")
ContainerDb(servicesDb, "Services Database", "PostgreSQL", "Конфигурация систем света")
ContainerDb(CacheStore, "Cache Store", "Redis", "Текущие состояния устройств")
Container(MessageBroker, "Message Broker", "RabbitMQ", "Очередь событий и команд")
Container(IotGateway, "IoT Gateway", "MQTT", "Шлюз к устройствам")

System_Ext(ApiGateway, "API Gateway", "Точка входа")
System_Ext(MonitoringService, "Monitoring Service", "Сервис мониторинга")
System_Ext(AutomationService, "Automation Service", "Сервис автоматизации")

' Связи API Layer
Rel(ApiGateway, LightingAPI, "HTTP/REST")
Rel(LightingAPI, CommandHandler, "Вызов команд")
Rel(LightingAPI, QueryHandler, "Запросы данных")

' Application Layer связи
Rel(CommandHandler, LightingDomainService, "Выполнение бизнес-логики")
Rel(QueryHandler, LightingRepo, "Получение данных")
Rel(SchedulerService, CommandHandler, "Выполнение по расписанию")

' Domain Layer связи
Rel(LightingDomainService, LightingAggregate, "Управление агрегатом")
Rel(LightingAggregate, ValueObjects, "Использует")
Rel(LightingDomainService, EventPublisher, "Публикация domain events")

' Infrastructure связи
Rel(LightingRepo, servicesDb, "SQL запросы")
Rel(DeviceRepo, deviceServiceDb, "SQL запросы")
Rel(LightingDomainService, LightingRepo, "Сохранение/получение")
Rel(LightingDomainService, DeviceRepo, "Работа с устройствами")

Rel(EventPublisher, MessageBroker, "Публикация событий", "AMQP")
Rel(MessageBroker, EventHandler, "Получение событий", "AMQP")
Rel(EventHandler, StateManager, "Обновление состояния")
Rel(EventHandler, LightingDomainService, "Обработка событий IoT")

Rel(StateManager, CacheStore, "Кэширование", "Redis Protocol")
Rel(CommandHandler, IotGateway, "Отправка команд", "MQTT")

' Внешние связи
Rel(AutomationService, LightingAPI, "Триггеры автоматизации", "REST")
Rel(EventPublisher, MonitoringService, "События для мониторинга", "AMQP")

@enduml